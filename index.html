<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rodeo Pfeffi Challenge</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; background: #121212; }
        canvas { display: block; }
        #menu {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: #32CD32;
        }
        #menu h1 {
            font-size: 36px; margin-bottom: 20px;
            text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000;
        }
        #menu button {
            font-size: 18px; padding: 10px 20px; cursor: pointer; color: white;
            background-color: #32CD32; border: none; border-radius: 5px;
        }
        #controls {
            position: absolute; bottom: 10px; width: 100%; display: flex;
            justify-content: center; gap: 20px; z-index: 20;
        }
        .control-button {
            width: 50px; height: 50px; font-size: 24px; background-color: #32CD32;
            border: none; border-radius: 50%; color: white; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
        }
        #alkometer {
            position: absolute; top: 50px; right: 10px; width: 200px; height: 30px;
            border: 2px solid #32CD32; background: #222; border-radius: 10px;
        }
        #alkometer-fill {
            height: 100%; background-color: #32CD32;
            border-radius: 8px 0 0 8px; width: 0;
            transition: width 0.3s cubic-bezier(.44,1.32,.81,1); /* smooth fill */
        }
        #alkometer-label {
            position: absolute; top: 20px; right: 10px; color: #32CD32;
            font-size: 18px; text-shadow: 2px 2px 0 #000, -2px -2px 0 #000;
        }
    </style>
</head>
<body>
    <div id="menu">
        <h1>Rodeo Pfeffi Challenge</h1>
        <button id="startBtn">Start Game</button>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="controls" style="display: none;">
        <button class="control-button" id="leftButton">◀</button>
        <button class="control-button" id="rightButton">▶</button>
        <button class="control-button" id="jumpButton">⮝</button>
    </div>
    <div id="alkometer-label">Alk-O-Meter</div>
    <div id="alkometer">
        <div id="alkometer-fill"></div>
    </div>
    <audio id="gameAudio" src="KI_Pfeffi.m4a" loop></audio>
    <script>
        // --- Canvas Setup ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- UI Elements ---
        const audio = document.getElementById('gameAudio');
        const controls = document.getElementById('controls');
        const leftBtn = document.getElementById('leftButton');
        const rightBtn = document.getElementById('rightButton');
        const jumpBtn = document.getElementById('jumpButton');
        const alkoFill = document.getElementById('alkometer-fill');
        const menu = document.getElementById('menu');
        const startBtn = document.getElementById('startBtn');

        // --- Images ---
        const IMAGES = {};
        const imageSources = {
            player: 'Ringo.png',
            bottle: 'Pfeffi.png',
            drunk: 'drunk1.png',
            background: 'Background.png'
        };
        let loadedImages = 0;
        function loadImages(sources, callback) {
            let numImages = Object.keys(sources).length;
            for (const key in sources) {
                IMAGES[key] = new Image();
                IMAGES[key].onload = () => {
                    loadedImages++;
                    if (loadedImages === numImages) callback();
                };
                IMAGES[key].src = sources[key];
            }
        }

        // --- Game Constants ---
        const LEVEL_WIDTH = 3000;
        const PLAYER_WIDTH = 100, PLAYER_HEIGHT = 100;
        const BOTTLE_WIDTH = 40, BOTTLE_HEIGHT = 80, BOTTLE_SPEED = 3;
        const DRUNK_WIDTH = 70, DRUNK_HEIGHT = 70, DRUNK_COUNT = 5;
        const GAME_DURATION = 90; // Sekunden

        // --- Game State ---
        let cameraX = 0;
        let bottles = [];
        let drunks = [];
        let score = 0;
        let gameTime = GAME_DURATION;
        let gameActive = false;
        let intervals = [];
        let rafId;

        const player = {
            width: PLAYER_WIDTH, height: PLAYER_HEIGHT,
            x: canvas.width / 2 - PLAYER_WIDTH / 2,
            y: canvas.height - 200,
            speed: 15,
            jumpPower: 25,
            gravity: 1.5,
            velocityY: 0,
            velocityX: 0,
            onGround: true,
            direction: 'right',
            autoMove: true,
            torkelAmount: 0
        };

        // --- Utility Functions ---
        function resetGameState() {
            bottles = [];
            drunks = [];
            score = 0;
            gameTime = GAME_DURATION;
            cameraX = 0;
            player.x = canvas.width / 2 - PLAYER_WIDTH / 2;
            player.y = canvas.height - 200;
            player.velocityY = 0;
            player.velocityX = 0;
            player.onGround = true;
            player.direction = 'right';
            player.autoMove = false;
            player.torkelAmount = 0;
            clearAllIntervals();
            cancelAnimationFrame(rafId);
        }
        function clearAllIntervals() {
            intervals.forEach(i => clearInterval(i));
            intervals = [];
        }

        // --- Drawing ---
        function drawBackground() {
            ctx.save();
            ctx.translate(-cameraX, 0);
            ctx.drawImage(IMAGES.background, 0, 0, LEVEL_WIDTH, canvas.height);
            ctx.restore();
        }
        function drawPlayer() {
            ctx.save();
            ctx.translate(-cameraX, 0);
            if (player.direction === 'left') {
                ctx.scale(-1, 1);
                ctx.drawImage(IMAGES.player, -player.x - player.width, player.y, player.width, player.height);
            } else {
                ctx.drawImage(IMAGES.player, player.x, player.y, player.width, player.height);
            }
            ctx.restore();
        }
        function drawBottle(bottle) {
            ctx.save();
            ctx.translate(-cameraX, 0);
            ctx.drawImage(IMAGES.bottle, bottle.x, bottle.y, BOTTLE_WIDTH, BOTTLE_HEIGHT);
            ctx.restore();
        }
        function drawDrunk(drunk) {
            ctx.save();
            ctx.translate(-cameraX, 0);
            ctx.drawImage(IMAGES.drunk, drunk.x, drunk.y, drunk.width, drunk.height);
            ctx.restore();
        }
        function drawScore() {
            ctx.fillStyle = '#32CD32';
            ctx.font = '24px Arial';
            ctx.fillText(`Score: ${score}`, 10, 30);
            ctx.fillText(`Time: ${gameTime}`, 10, 60);
        }

        // --- Logic ---
        function spawnBottle() {
            const x = Math.random() * (LEVEL_WIDTH - BOTTLE_WIDTH);
            bottles.push({ x, y: 0 });
        }
        function spawnDrunks() {
            for (let i = 0; i < DRUNK_COUNT; i++) {
                const x = Math.random() * (LEVEL_WIDTH - DRUNK_WIDTH);
                drunks.push({ x, y: canvas.height - 170, width: DRUNK_WIDTH, height: DRUNK_HEIGHT });
            }
        }
        function updateBottles() {
            for (let i = bottles.length - 1; i >= 0; i--) {
                bottles[i].y += BOTTLE_SPEED;
                // Remove bottle if below screen
                if (bottles[i].y > canvas.height) {
                    bottles.splice(i, 1);
                    continue;
                }
                // Collision with player
                if (
                    bottles[i].x < player.x + player.width &&
                    bottles[i].x + BOTTLE_WIDTH > player.x &&
                    bottles[i].y < player.y + player.height &&
                    bottles[i].y + BOTTLE_HEIGHT > player.y
                ) {
                    score++;
                    updateAlkometer();
                    bottles.splice(i, 1);
                }
            }
        }
        function updateAlkometer() {
            const fillPerc = Math.min(score / 30, 1);
            alkoFill.style.width = (fillPerc * 100) + '%';
            player.torkelAmount = fillPerc * 20;
        }
        function applyGravity() {
            if (!player.onGround) {
                player.y += player.velocityY;
                player.x += player.velocityX;
                player.velocityY += player.gravity;
                if (player.y >= canvas.height - 200) {
                    player.y = canvas.height - 200;
                    player.onGround = true;
                    player.velocityY = 0;
                    player.velocityX = 0;
                }
            }
        }
        function checkDrunkCollision() {
            for (const drunk of drunks) {
                if (
                    player.x < drunk.x + drunk.width &&
                    player.x + player.width > drunk.x &&
                    player.y < drunk.y + drunk.height &&
                    player.y + player.height > drunk.y
                ) {
                    if (player.direction === 'left') {
                        player.x = drunk.x + drunk.width;
                    } else {
                        player.x = drunk.x - player.width;
                    }
                    updateCamera();
                }
            }
        }
        function torkel() {
            if (score > 0) {
                player.x += (Math.random() - 0.5) * player.torkelAmount;
                updateCamera();
            }
        }
        function updateCamera() {
            cameraX = Math.max(0, Math.min(player.x - canvas.width / 2 + player.width / 2, LEVEL_WIDTH - canvas.width));
        }

        // --- Input ---
        function movePlayer(e) {
            if (!gameActive) return;
            player.autoMove = false;
            const move = player.speed;
            if (['ArrowLeft', 'a', 'A'].includes(e.key)) {
                player.x -= move;
                player.direction = 'left';
            } else if (['ArrowRight', 'd', 'D'].includes(e.key)) {
                player.x += move;
                player.direction = 'right';
            } else if ((e.key === ' ' || e.key === 'Spacebar') && player.onGround) {
                jump();
            }
            updateCamera();
        }
        function jump() {
            if (player.onGround) {
                player.velocityY = -player.jumpPower;
                player.velocityX = player.direction === 'left' ? -player.speed : player.speed;
                player.onGround = false;
            }
        }
        function handleTouch(e) {
            if (!gameActive) return;
            if (e.touches.length > 0) {
                const touch = e.touches[0];
                player.autoMove = false;
                if (touch.clientX < canvas.width / 2) {
                    player.x -= player.speed;
                    player.direction = 'left';
                } else {
                    player.x += player.speed;
                    player.direction = 'right';
                }
                updateCamera();
            }
        }

        // --- Controls (mobile/desktop) ---
        leftBtn.addEventListener('touchstart', e => { e.preventDefault(); player.autoMove = false; player.x -= player.speed; player.direction = 'left'; updateCamera(); });
        rightBtn.addEventListener('touchstart', e => { e.preventDefault(); player.autoMove = false; player.x += player.speed; player.direction = 'right'; updateCamera(); });
        jumpBtn.addEventListener('touchstart', e => { e.preventDefault(); jump(); });

        window.addEventListener('keydown', movePlayer);
        window.addEventListener('touchstart', handleTouch);

        // --- Main Game Loop ---
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            drawPlayer();
            updateBottles();
            bottles.forEach(drawBottle);
            drunks.forEach(drawDrunk);
            drawScore();
            applyGravity();
            checkDrunkCollision();
            rafId = requestAnimationFrame(gameLoop);
        }

        // --- Menu Animation ---
        function menuAnimation() {
            // Player läuft automatisch links/rechts im Menü
            player.autoMove = true;
            const switchDir = setInterval(() => { player.direction = (player.direction === 'left') ? 'right' : 'left'; }, 2000);
            const anim = setInterval(() => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawBackground();
                if (player.autoMove) {
                    if (player.direction === 'left') {
                        player.x -= player.speed;
                        if (player.x < 0) {
                            player.x = 0;
                            player.direction = 'right';
                        }
                    } else {
                        player.x += player.speed;
                        if (player.x + player.width > LEVEL_WIDTH) {
                            player.x = LEVEL_WIDTH - player.width;
                            player.direction = 'left';
                        }
                    }
                    updateCamera();
                }
                drawPlayer();
            }, 100);
            intervals.push(anim, switchDir);
        }

        // --- Game Start ---
        function startGame() {
            resetGameState();
            menu.style.display = 'none';
            canvas.style.display = 'block';
            controls.style.display = 'flex';
            gameActive = true;

            // Start Audio
            audio.volume = 0.6;
            audio.play().catch(() => { /* silent error */ });

            // Spawn Drunks
            spawnDrunks();

            // Timers
            intervals.push(setInterval(spawnBottle, 1000));
            intervals.push(setInterval(torkel, 100));
            intervals.push(setInterval(() => {
                gameTime--;
                if (gameTime <= 0) {
                    endGame();
                }
            }, 1000));

            gameLoop();
        }

        function endGame() {
            gameActive = false;
            clearAllIntervals();
            cancelAnimationFrame(rafId);
            setTimeout(() => {
                alert('Game Over! Your score: ' + score);
                location.reload();
            }, 200);
        }

        // --- Init: Images + Menü + Audio ---
        loadImages(imageSources, () => {
            // Init player pos
            player.x = canvas.width / 2 - PLAYER_WIDTH / 2;
            player.y = canvas.height - 200;
            menuAnimation();
        });

        // --- UI: Start-Button ---
        startBtn.onclick = () => {
            clearAllIntervals();
            startGame();
        };

        // --- Autoplay fix for Audio (Mobile) ---
        window.onload = () => {
            audio.play().catch(() => {});
        };
    </script>
</body>
</html>
